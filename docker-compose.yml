version: '3.8'

services:
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: wardragon-timescaledb
    environment:
      POSTGRES_DB: wardragon
      POSTGRES_USER: wardragon
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8"
      TIMESCALEDB_TELEMETRY: "off"
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ./timescaledb/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - wardragon-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wardragon -d wardragon"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    shm_size: 256MB
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "log_min_duration_statement=1000"

  collector:
    build:
      context: ./app
      dockerfile: Dockerfile
      target: collector
    container_name: wardragon-collector
    environment:
      DATABASE_URL: postgresql://wardragon:${DB_PASSWORD}@timescaledb:5432/wardragon
      KITS_CONFIG: /config/kits.yaml
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      POLL_INTERVAL_DRONES: ${POLL_INTERVAL_DRONES:-5}
      POLL_INTERVAL_STATUS: ${POLL_INTERVAL_STATUS:-30}
      MAX_RETRIES: ${MAX_RETRIES:-3}
      RETRY_BACKOFF_FACTOR: ${RETRY_BACKOFF_FACTOR:-2}
    volumes:
      - ./config:/config:ro
      - ./logs/collector:/app/logs
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - wardragon-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os; exit(0 if os.path.exists(\"/tmp/collector_healthy\") else 1)' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  web:
    build:
      context: ./app
      dockerfile: Dockerfile
      target: web
    container_name: wardragon-web
    environment:
      DATABASE_URL: postgresql://wardragon:${DB_PASSWORD}@timescaledb:5432/wardragon
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      API_TITLE: "WarDragon Analytics API"
      API_VERSION: "1.0.0"
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      MAX_QUERY_RANGE_HOURS: ${MAX_QUERY_RANGE_HOURS:-168}
    ports:
      - "${WEB_PORT:-8080}:8080"
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - wardragon-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    image: grafana/grafana:latest
    container_name: wardragon-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_SECURITY_SECRET_KEY: ${GRAFANA_SECRET_KEY}
      GF_INSTALL_PLUGINS: grafana-worldmap-panel,grafana-piechart-panel
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:3000}
      GF_DATABASE_TYPE: postgres
      GF_DATABASE_HOST: timescaledb:5432
      GF_DATABASE_NAME: grafana
      GF_DATABASE_USER: wardragon
      GF_DATABASE_PASSWORD: ${DB_PASSWORD}
      GF_DATABASE_SSL_MODE: disable
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_LOG_LEVEL: ${GRAFANA_LOG_LEVEL:-info}
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_SECURITY_DISABLE_GRAVATAR: "true"
      GF_SECURITY_COOKIE_SECURE: "true"
      GF_SECURITY_COOKIE_SAMESITE: "strict"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/dashboards-json:/var/lib/grafana/dashboards:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - wardragon-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    user: "472:472"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  wardragon-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  timescale-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${VOLUMES_PATH:-./volumes}/timescale-data
  grafana-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${VOLUMES_PATH:-./volumes}/grafana-data
