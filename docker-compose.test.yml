version: '3.8'

# WarDragon Analytics - Test Stack Configuration
# Lightweight configuration for integration testing
#
# Usage:
#   docker-compose -f docker-compose.test.yml up -d
#   pytest -m integration
#   docker-compose -f docker-compose.test.yml down -v

services:
  timescaledb-test:
    image: timescale/timescaledb:latest-pg15
    container_name: wardragon-timescaledb-test
    environment:
      POSTGRES_DB: wardragon
      POSTGRES_USER: wardragon
      POSTGRES_PASSWORD: test_password
      POSTGRES_INITDB_ARGS: "-E UTF8"
      TIMESCALEDB_TELEMETRY: "off"
    volumes:
      - ./timescaledb/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "127.0.0.1:5432:5432"
    networks:
      - wardragon-test-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wardragon -d wardragon"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    shm_size: 128MB
    command:
      - "postgres"
      - "-c"
      - "max_connections=50"
      - "-c"
      - "shared_buffers=128MB"
      - "-c"
      - "effective_cache_size=512MB"
      - "-c"
      - "work_mem=2MB"
      - "-c"
      - "log_min_duration_statement=-1"  # Disable slow query logging for tests

  web-test:
    build:
      context: ./app
      dockerfile: Dockerfile
      target: web
    container_name: wardragon-web-test
    environment:
      DATABASE_URL: postgresql://wardragon:test_password@timescaledb-test:5432/wardragon
      LOG_LEVEL: WARNING  # Reduce log noise during tests
      API_TITLE: "WarDragon Analytics API (Test)"
      API_VERSION: "1.0.0-test"
      CORS_ORIGINS: "*"
      MAX_QUERY_RANGE_HOURS: 168
    ports:
      - "127.0.0.1:8090:8090"
    depends_on:
      timescaledb-test:
        condition: service_healthy
    networks:
      - wardragon-test-net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8090/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  wardragon-test-net:
    driver: bridge

# No persistent volumes for test stack - everything is ephemeral
# Use 'docker-compose -f docker-compose.test.yml down -v' to clean up
